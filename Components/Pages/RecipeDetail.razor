@page "/recipedetail"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Microsoft.AspNetCore.Components.Web
@using System
@using RecipeApp.Models
@using RecipeApp.Services
@inject RecipeService InMemoryService
@inject RecipesFromJSONService JsonService
@inject RecipesFromWebService WebService
@inject NavigationManager Navigation
@inject NutritionService NutritionService

<PageTitle>@(CurrentRecipe?.Title ?? "Recipe Details")</PageTitle>

<h1>Recipe Details</h1>

@if (string.IsNullOrEmpty(RecipeTitle))
{
    <p><em>No recipe selected.</em></p>
}
else
{
    var effectiveSource = Source ?? "inmemory";

    IRecipeService selectedService = effectiveSource switch
    {
        "json" => JsonService,
        "web" => WebService,
        _ => InMemoryService
    };

    var sourceDisplay = effectiveSource switch
    {
        "json" => "JSON file",
        "web" => "web API",
        _ => "in-memory"
    };

    if (CurrentRecipe == null)
    {
        <p><em>Recipe "@RecipeTitle" not found in the @sourceDisplay data source.</em></p>
    }
    else
    {
        <p><em>Loaded from @sourceDisplay data.</em></p>

        @if (CurrentRecipe?.TotalNutrition != null)
        {
            <h3>Nutritional Profile (Total / Per Serving)</h3>
            <ul>
                <li>Calories: @CurrentRecipe.TotalNutrition.Calories (@CurrentRecipe.PerServingNutrition?.Calories)</li>
                <li>Protein: @CurrentRecipe.TotalNutrition.Protein g (@CurrentRecipe.PerServingNutrition?.Protein g)</li>
                <li>Carbs: @CurrentRecipe.TotalNutrition.Carbs g (@CurrentRecipe.PerServingNutrition?.Carbs g)</li>
                <li>Fat: @CurrentRecipe.TotalNutrition.Fat g (@CurrentRecipe.PerServingNutrition?.Fat g)</li>
            </ul>

            @if (CurrentRecipe.IngredientMatches?.Any() == true)
            {
                <h4>Ingredient Matches</h4>
                <ul>
                    @foreach (var match in CurrentRecipe.IngredientMatches)
                    {
                        <li>@match.Description (score: @match.MatchScore)</li>
                    }
                </ul>
            }
        }


        <h2>@CurrentRecipe?.Title</h2>
        <p><strong>Serves:</strong> @CurrentRecipe?.Yield</p>

        <h3>Ingredients</h3>
        <ul style="font-size: 1.1rem; line-height: 1.8;">
            @foreach (var ingredient in CurrentRecipe?.Ingredients ?? new List<string>())
            {
                <li>@ingredient</li>
            }
        </ul>

        <div class="mt-3">
            <NavLink class="btn btn-outline-primary me-2"
                     href="@($"/editrecipe?title={Uri.EscapeDataString(CurrentRecipe?.Title ?? "")}&source={effectiveSource}")">
                Edit Recipe
            </NavLink>
            <button type="button" class="btn btn-outline-danger" @onclick="DeleteRecipe">Delete Recipe</button>
        </div>
    }

    var backHref = effectiveSource == "json" ? "/recipesfromjson" :
                   effectiveSource == "web" ? "/recipefromwebjson" : "/";

    var backText = effectiveSource == "json" ? "Recipes from JSON" :
                   effectiveSource == "web" ? "Recipes from Web API" : "Available Recipes";

    <NavLink class="d-block mt-3" href="@backHref">← Back to @backText</NavLink>
}

@code {
    [SupplyParameterFromQuery(Name = "title")]
    public string RecipeTitle { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "source")]
    public string? Source { get; set; }

    private Recipe? CurrentRecipe;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(RecipeTitle))
        {
            var effectiveSource = Source ?? "inmemory";
            IRecipeService selectedService = effectiveSource switch
            {
                "json" => JsonService,
                "web" => WebService,
                _ => InMemoryService
            };

            CurrentRecipe = selectedService.GetRecipeByTitle(RecipeTitle);
        }

        await NutritionService.ComputeNutritionAsync(CurrentRecipe!);
    }

    private void DeleteRecipe()
    {
        if (CurrentRecipe == null) return;

        var effectiveSource = Source ?? "inmemory";
        IRecipeService selectedService = effectiveSource switch
        {
            "json" => JsonService,
            "web" => WebService,
            _ => InMemoryService
        };

        selectedService.DeleteRecipe(RecipeTitle);

        var backHref = effectiveSource == "json" ? "/recipesfromjson" :
                       effectiveSource == "web" ? "/recipefromwebjson" : "/";

        Navigation.NavigateTo(backHref);
    }
}